---
title: "Introduction to ssmRG R-package"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Introduction to ssmRG R-package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T)
library(ssmRG)
```

This vignette introduces you to ssmRG functions and shows you how to apply them to estimate morphometric size at sexual maturity based on relative growth (allometric relationship).


## Load data
```{r echo=TRUE}
data(crabdata)

head(crabdata)

names(crabdata)
```


## Classify data and plot
The `classify_data` function classify the individuals in two groups (juvelines = 0 and adult = 1). The classification analisys is based on Principal Components Analisys with two allometric variables (x: independent variable, y: dependent variable) in log base, allowing to distinguish two groups that would represent juveniles and adult. The individuals are assigned to each group using a hierarchical classification procedure (hierarchical cluster). This method is based on establishing a predetermined number of groups (in this case, two) and assigning individuals to one of the groups according to their loads on the two axes of the PCA (Corgos & Freire, 2006).

Using the results of the classification (PCA + cluster), a discriminant analysis (linear or quadratic) is conducted to obtain a discriminating function that permitted any individuals to be classified as a juvenile or an adult on the basis of the X and Y variables.

The `classify_data` function requires a data.frame (e.g. crabdata) with alometric variables and sex category. The argument `varnames` is a character string that requires two allometric variables only, and `varsex` requires the sex variable name. If the argument `selecSex` is `NULL` all the individuals will be used in the classification analysis. Finally the `method` is focus in the discriminant analysis to be used ("ld": linear discriminant analysis, "qd": quadratic discriminant analysis), if `method` is `NULL` ld or qd will be used in the discrimination analysis based on the test of homogeneity of covariance matrices.

The `classify_data` function returns an object of class "classify", with the allometric variables "x" (independent) and "y"" (dependent), and classification stage (juveniles = 0, adult = 1).

```{r, echo = TRUE}
#For all the individuals
classify_data = classify_mature(crabdata, varnames = c("carapace_width", "chela_heigth"), 
varsex = "sex_category", selectSex = NULL, method = "ld")

#For males only
classify_data_males = classify_mature(crabdata, varnames = c("carapace_width", "chela_heigth"), 
varsex = "sex_category", selectSex = "m", method = "ld")

```

The example shows the arguments that can be used in the plot:

```{r, echo = TRUE, fig.width = 10, fig.height = 10, results='hide', warning=FALSE}
par(mfrow = c(2,2))
plot(classify_data)

plot(classify_data, xlab = "Carapace width (mm.)", ylab = "Chela heigth (mm)")

plot(classify_data, xlab = "Carapace width (mm.)", ylab = "Chela heigth (mm)", 
     col = c(2, 3), pch = c(5, 6))

plot(classify_data, xlab = "Carapace width (mm.)", ylab = "Chela heigth (mm)", 
     col = c(2, 3), pch = c(5, 6), lty_lines = c(1, 2), lwd_lines = c(1, 3), 
     cex = c(1, 3), main = "Classification")
```


## Estimate morphometric size at sexual maturity (maturity ogive estimation)
The `calculate_mature` use the logistic approach (frequentist or bayesian). The morphometric size at 50% maturity ($L_{50}$) was estimated as the length at which a randomly chosen specimen has a 50% chance of being mature (Somerton  1980, Roa  et al.  1999). 

In the regression analysis, $X$ (e.g: carapace width) is considered the explanatory variable and the classification stage $CS$ (juvelines: 0, adults: 1) is considered the response variable (binomial). The variables are fitted to a logistic function with the form: 

$$P_{CS} = 1/1+e^{-(\hat{\beta}_{0} + \hat{\beta}_{1}*X)}$$

where $P_{CL}$ is the probability of an individual of being mature at a determinate $X$ length. $\hat{\beta}_{0}$ (intercept) and $\hat{\beta}_{1}$ (slope) are parameters estimated. The $L_{50}$ is calculated as:

$$L_{50} = -\frac{\hat{\beta}_{0}}{\hat{\beta}_{1}}$$


The `calculate_mature` function requires an object of class "classify" with the X, Y (allometric variables) and classification stage (juvelines = 0, adults = 1).

The argument `method` requires a string character indicanting which regression will be used for the test.
If `method = "fq"` the regression is based on GLM (frequentist) and if `method = "bayes"` a sample from the posterior distribution of a logistic regression model using a random walk Metropolis algorithm is generated (see MCMClogit function).

The argument `niter` requires a number. For the GLM regression (`method = "fq"`), a non-parametric bootstrap method consists in generate B bootstrap samples, by resampling with replacement the original data. Then all statistics for each parameter can be calculated from each bootstrap sample (median and confidence intervals). For the `method = "bayes"`, the argument `niter` is related to the number of Metropolis iterations for the sampler.

The output is an object of class "mature". This object contains a dataframe with the X, Y and mature classification variables. Also the fitted values for the curve logistic regression and confidence intervals (95\%). If you print the object the median and confidence intervals (for `method = "bayes"` - credible intervals) of the morphometric size at sexual maturity estimation (L50).

```{r echo = TRUE}
#Frequentist regression 
my_mature_fq = calculate_mature(classify_data, method = "fq", niter = 1000)

print(my_mature_fq)


#Bayesian regression
my_mature_bayes = calculate_mature(classify_data, method = "bayes", niter = 1000)

print(my_mature_bayes)
```


## Plot maturity ogive
For plotting the maturity ogive you need the object of class "mature". But the function `plot` generates 4 graphics: 1), 2) and 3) are histograms for the A, B parameters and the morphometric size at sexual maturity (L50), the last is the maturity ogive.

```{r echo = TRUE, fig.width = 10, fig.height = 10, warning=FALSE}
par(mfrow = c(2,2))
plot(my_mature_fq, xlab = "Carapace width (mm.)", ylab = "Proportion mature", col = c("blue", "red"))

par(mfrow = c(2,2))
plot(my_mature_bayes, xlab = "Carapace width (mm.)", ylab = "Proportion mature", col = c("blue", "red"))
```

This methodology has been used mainly in the estimation of morphological sexual maturity in crabs, but it can be extended to other taxas as Agostinho (2000) reported. 


##References

Agostinho, C. S. (2000). Use of otoliths to estimate size at sexual maturity in fish. Brazilian Archives of Biology and Technology, 43(4).

Corgos, A. & Freire, J. (2006). Morphometric and gonad maturity in the spider crab Maja brachydactyla: a comparison of methods for estimating size at maturity in species with determinate growth. ICES Journal of Marine Science: Journal du Conseil, 63(5), 851-859.

Roa, R., Ernst, B. & Tapia, F. (1999). Estimation of size at sexual maturity: an evaluation of analytical and resampling procedures. Fishery Bulletin, 97(3), 570-580.

Somerton, D. A. (1980). A computer technique for estimating the size of sexual maturity in crabs. Canadian Journal of Fisheries and Aquatic Sciences, 37(10), 1488-1494.